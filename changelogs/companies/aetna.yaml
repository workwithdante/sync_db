databaseChangeLog:
    - changeSet:
        id: create_schema_aetna
        author: workwithdante
        changes:
            - sql:
                sql: CREATE SCHEMA IF NOT EXISTS aetna;
        rollback:
            - sql:
                sql: DROP SCHEMA IF EXISTS aetna;

    - changeSet:
        id: create_unlogged_temp_aetna
        author: workwithdante
        changes:
            - sql:
                sql: |
                    CREATE UNLOGGED TABLE IF NOT EXISTS aetna.temp (
                        "Member Name"                   TEXT,
                        "DOB"                           TEXT,
                        "Exchange Assigned ID"          TEXT,
                        "Issuer Assigned ID"            TEXT,
                        "Metal Tier"                    TEXT,
                        "Member Plan ID"                TEXT,
                        "Member Plan Name"              TEXT,
                        "Household Size"                TEXT,
                        "Relationship"                  TEXT,
                        "Plan Effective Date"           TEXT,
                        "Monthly Premium"               TEXT,
                        "AutoPay Status"                TEXT,
                        "Payment Status"                TEXT,
                        "Account Status"                TEXT,
                        "Paid Through Date"             TEXT,
                        "Primary Contact"               TEXT,
                        "Mailing Address"               TEXT,
                        "County"                        TEXT,
                        "State"                         TEXT,
                        "Zip"                           TEXT
                    );

        rollback:
            - sql:
                sql: DROP TABLE IF EXISTS aetna.temp;

    - changeSet:
        id: create_view_bs_aetna
        author: workwithdante
        preConditions:
            - dbms:
                type: postgresql
        changes:
            - createView:
                schemaName: aetna
                viewName: bs
                replaceIfExists: true
                selectQuery: |
                    SELECT
                        temp.*
                    FROM aetna.temp AS temp
                    WHERE temp."Relationship" = 'Self';

    - changeSet:
        id: create_status_aetna
        author: workwithdante
        runOnChange: true
        changes:
            - sql:
                splitStatements: false
                stripComments: true
                sql: |                        
                    CREATE OR REPLACE FUNCTION aetna.get_status(input_data_csv JSONB, input_data_crm JSONB)
                        RETURNS TABLE(status TEXT, new_clean_input_data_csv JSONB)
                        LANGUAGE plpgsql
                        STABLE
                    AS $$
                        BEGIN
                            new_clean_input_data_csv :=  jsonb_strip_nulls(input_data_csv);

                            status := callers.evaluate_status(new_clean_input_data_csv, input_data_crm);
                            RETURN NEXT;
                        END;
                    $$;
        rollback:
            - sql:
                splitStatements: false
                stripComments: true
                sql: DROP FUNCTION IF EXISTS aetna.get_status(JSONB, JSONB);